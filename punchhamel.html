<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Punch Hamel ‚ùÑ</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111111">

<style>
:root{
  --bg:#111;
  --card:#1b1b1b;
  --field:#2d2d2d;
  --field-focus:#3a3a3a;
  --text:#ffffff;
}
body.light{
  --bg:#f2f2f2;
  --card:#ffffff;
  --field:#e7e7e7;
  --field-focus:#d4d4d4;
  --text:#111111;
}
body{
  background:var(--bg);
  color:var(--text);
  font-family:Arial, sans-serif;
  margin:0;
  padding:30px;
  transition:background .2s,color .2s;
}
.container{max-width:950px;margin:0 auto;}

.card{
  background:var(--card);
  padding:20px;
  margin-top:10px;
  border-radius:10px;
  border:1px solid #333;
}

input,select{
  padding:8px;
  margin:4px;
  border-radius:6px;
  background:var(--field);
  color:var(--text);
  border:1px solid #555;
  font-weight:500;
}
input:focus,select:focus{
  background:var(--field-focus);
  border-color:#888;
  outline:none;
}

button{
  background:#333;
  color:#fff;
  padding:8px 12px;
  border:none;
  border-radius:6px;
  margin:2px;
  cursor:pointer;
}
button:hover{background:#444;}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
}
th,td{
  border:1px solid #333;
  padding:8px;
  text-align:center;
}

.recap{
  background:var(--card);
  margin-top:15px;
  padding:15px;
  border-radius:10px;
  border:1px solid #222;
}
.info-prime{
  margin:5px 0 0 4px;
  color:gray;
  font-size:13px;
}
</style>

<script>
// Toggle th√®me + sauvegarde
function toggleTheme(){
  document.body.classList.toggle('light');
  const mode = document.body.classList.contains('light') ? 'light' : 'dark';
  localStorage.setItem('theme', mode);
}

// Service worker PWA
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(()=>{});
  });
}
</script>
</head>

<body>

<div class="container">
  <h2>Calcul heures & salaire</h2>

  <button onclick="toggleTheme()">Mode sombre / clair</button>
  <button onclick="exportCSV()">Exporter CSV</button>

  <div class="card">
    Taux horaire ($/h)
    <input type="number" id="rate" value="35" style="width:80px;">

    <br><br>

    Date
    <input type="date" id="date">

    Entr√©e
    <select id="in"></select>

    Sortie
    <select id="out"></select>

    Pause (minutes)
    <input type="number" id="pause" value="0" style="width:80px;">

    <div class="info-prime">
      Prime nuit : 2$/h (19h ‚Üí 07h) ‚Ä¢ Prime fin semaine : 5$/h (ven 17h ‚Üí lun 05h)
    </div>

    <br>

    <button onclick="addShift()">Ajouter le shift</button>
    <button onclick="clearAll()">Effacer tout</button>

    <table id="table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Entr√©e</th>
          <th>Sortie</th>
          <th>Pause</th>
          <th>Heures</th>
          <th>Nuit h</th>
          <th>Fin sem. h</th>
          <th>Salaire $</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="recap">
      <b>R√©capitulatif</b><br>
      Total heures : <span id="th">0.00</span> h<br>
      Total salaire brut : <span id="ts">0.00</span> $
    </div>
  </div>
</div>

<script>
// R√©f√©rences DOM
const inSelect      = document.getElementById('in');
const outSelect     = document.getElementById('out');
const dateInput     = document.getElementById('date');
const pauseInput    = document.getElementById('pause');
const rateInput     = document.getElementById('rate');
const tableBody     = document.querySelector('#table tbody');
const totalHoursEl  = document.getElementById('th');
const totalSalaryEl = document.getElementById('ts');

// G√©n√©ration des heures 00 / 15 / 30 / 45
function populateTimeSelect(select){
  for (let h = 0; h < 24; h++) {
    for (let m of [0,15,30,45]) {
      const HH = String(h).padStart(2,'0');
      const MM = String(m).padStart(2,'0');
      const opt = document.createElement('option');
      opt.value = `${HH}:${MM}`;
      opt.textContent = `${HH}:${MM}`;
      select.appendChild(opt);
    }
  }
}

// Cr√©ation d'un select de temps pour l'√©dition
function createTimeSelect(selected){
  const s = document.createElement('select');
  populateTimeSelect(s);
  if (selected) s.value = selected;
  return s;
}

// Diff√©rence en heures
const hoursDiff = (a,b) => (b - a) / 36e5;

// Chevauchement de deux intervalles de temps
function overlap(startA, endA, startB, endB){
  const start = Math.max(startA, startB);
  const end   = Math.min(endA, endB);
  return end > start ? hoursDiff(start, end) : 0;
}

// Fen√™tre weekend : vendredi 17h ‚Üí lundi 05h
function weekendWindow(startDate){
  const d = new Date(startDate);
  const day = d.getDay(); // 0 = dimanche
  const fri = new Date(d);
  const offset = (day - 5 + 7) % 7; // nb de jours √† remonter pour vendredi
  fri.setDate(d.getDate() - offset);
  fri.setHours(17,0,0,0);

  const mon = new Date(fri);
  mon.setDate(fri.getDate() + 3);
  mon.setHours(5,0,0,0);

  return [fri, mon];
}

// Fen√™tre nuit : 19h ‚Üí 07h
function nightWindow(startDate){
  const ns = new Date(startDate);
  ns.setHours(19,0,0,0);

  const ne = new Date(startDate);
  ne.setDate(ne.getDate() + 1);
  ne.setHours(7,0,0,0);

  return [ns, ne];
}

// Ajouter un shift
function addShift(){
  const d = dateInput.value;
  const tin  = inSelect.value;
  const tout = outSelect.value;
  const pauseMin = parseFloat(pauseInput.value) || 0;
  const rate = parseFloat(rateInput.value) || 0;

  if (!d || !tin || !tout) {
    alert("Veuillez saisir la date, l'entr√©e et la sortie.");
    return;
  }

  const row = buildRow(d,tin,tout,pauseMin,rate);
  tableBody.appendChild(row);
  recalc();
}

// Construit une ligne de tableau (tr) √† partir des donn√©es de punch
function buildRow(d,tin,tout,pauseMin,rate){
  let start = new Date(`${d}T${tin}`);
  let end   = new Date(`${d}T${tout}`);
  if (end <= start) end.setDate(end.getDate() + 1);

  const totalHours = hoursDiff(start, end) - (pauseMin / 60);

  const [wStart, wEnd] = weekendWindow(start);
  const weekendHours = overlap(start.getTime(), end.getTime(), wStart.getTime(), wEnd.getTime());

  const [nStart, nEnd] = nightWindow(start);
  const nightHours = overlap(start.getTime(), end.getTime(), nStart.getTime(), nEnd.getTime());

  const weekendBonus = 5;
  const nightBonus   = 2;

  const salary =
    totalHours  * rate +
    weekendHours * weekendBonus +
    nightHours   * nightBonus;

  const tr = document.createElement('tr');
  tr.dataset.type = "shift"; // pour le tri plus tard
  tr.innerHTML = `
    <td>${d}</td>
    <td>${tin}</td>
    <td>${tout}</td>
    <td>${pauseMin}</td>
    <td>${totalHours.toFixed(2)}</td>
    <td>${nightHours.toFixed(2)}</td>
    <td>${weekendHours.toFixed(2)}</td>
    <td>${salary.toFixed(2)}$</td>
    <td>
      <button onclick="editRow(this)">‚úè</button>
      <button onclick="deleteRow(this)">X</button>
    </td>
  `;
  return tr;
}

// Supprimer une ligne
function deleteRow(btn){
  const tr = btn.closest('tr');
  tr.remove();
  recalc();
}

// √âdition inline
function editRow(btn){
  const tr = btn.closest('tr');
  if (tr.dataset.editing === "1") return;
  tr.dataset.editing = "1";

  const cells = tr.children;
  const oldData = {
    date : cells[0].innerText,
    in   : cells[1].innerText,
    out  : cells[2].innerText,
    pause: cells[3].innerText
  };
  tr.dataset.orig = JSON.stringify(oldData);

  // Date
  const dateInput = document.createElement('input');
  dateInput.type = "date";
  dateInput.value = oldData.date;
  cells[0].innerHTML = "";
  cells[0].appendChild(dateInput);

  // Entr√©e
  const inSel = createTimeSelect(oldData.in);
  cells[1].innerHTML = "";
  cells[1].appendChild(inSel);

  // Sortie
  const outSel = createTimeSelect(oldData.out);
  cells[2].innerHTML = "";
  cells[2].appendChild(outSel);

  // Pause
  const pauseInput = document.createElement('input');
  pauseInput.type = "number";
  pauseInput.value = oldData.pause;
  pauseInput.style.width = "70px";
  cells[3].innerHTML = "";
  cells[3].appendChild(pauseInput);

  // Boutons Save / Cancel
  cells[8].innerHTML = `
    <button onclick="saveEdit(this)">‚úî</button>
    <button onclick="cancelEdit(this)">‚Ü©</button>
  `;
}

function saveEdit(btn){
  const tr = btn.closest('tr');
  const cells = tr.children;

  const d    = cells[0].querySelector('input').value;
  const tin  = cells[1].querySelector('select').value;
  const tout = cells[2].querySelector('select').value;
  const pauseMin = parseFloat(cells[3].querySelector('input').value) || 0;
  const rate = parseFloat(rateInput.value) || 0;

  // Reconstruire les donn√©es avec buildRow (mais sans cr√©er une nouvelle ligne)
  let start = new Date(`${d}T${tin}`);
  let end   = new Date(`${d}T${tout}`);
  if (end <= start) end.setDate(end.getDate() + 1);

  const totalHours = hoursDiff(start, end) - (pauseMin / 60);

  const [wStart, wEnd] = weekendWindow(start);
  const weekendHours = overlap(start.getTime(), end.getTime(), wStart.getTime(), wEnd.getTime());

  const [nStart, nEnd] = nightWindow(start);
  const nightHours = overlap(start.getTime(), end.getTime(), nStart.getTime(), nEnd.getTime());

  const weekendBonus = 5;
  const nightBonus   = 2;

  const salary =
    totalHours  * rate +
    weekendHours * weekendBonus +
    nightHours   * nightBonus;

  // R√©√©crire les cellules en mode "lecture"
  cells[0].innerText = d;
  cells[1].innerText = tin;
  cells[2].innerText = tout;
  cells[3].innerText = pauseMin;
  cells[4].innerText = totalHours.toFixed(2);
  cells[5].innerText = nightHours.toFixed(2);
  cells[6].innerText = weekendHours.toFixed(2);
  cells[7].innerText = salary.toFixed(2) + "$";
  cells[8].innerHTML = `
    <button onclick="editRow(this)">‚úè</button>
    <button onclick="deleteRow(this)">X</button>
  `;

  tr.dataset.editing = "0";
  recalc();
}

function cancelEdit(btn){
  const tr = btn.closest('tr');
  const orig = JSON.parse(tr.dataset.orig || "{}");
  const cells = tr.children;

  if(orig.date){
    cells[0].innerText = orig.date;
    cells[1].innerText = orig.in;
    cells[2].innerText = orig.out;
    cells[3].innerText = orig.pause;
  }

  cells[8].innerHTML = `
    <button onclick="editRow(this)">‚úè</button>
    <button onclick="deleteRow(this)">X</button>
  `;
  tr.dataset.editing = "0";
  recalc();
}

// TRI + s√©paration par semaine + total semaine
function recalc(){
  let allRows = [...tableBody.querySelectorAll("tr")];
  let dataRows = allRows.filter(r => r.dataset.type === "shift");

  // tri par date
  dataRows.sort((a,b)=>{
    let da = new Date(a.children[0].innerText);
    let db = new Date(b.children[0].innerText);
    return da - db;
  });

  tableBody.innerHTML = "";

  let lastWeekKey = null;
  let weeklyHours = 0;
  let weeklySalary = 0;
  let totalH = 0;
  let totalS = 0;

  dataRows.forEach((r,idx)=>{
    let date = new Date(r.children[0].innerText);

    // Lundi de la semaine
    let weekStart = new Date(date);
    weekStart.setDate(date.getDate() - ((date.getDay()+6)%7));
    let key = weekStart.toISOString().slice(0,10);

    if(key !== lastWeekKey){
      // si on change de semaine, on √©crit le total de la semaine pr√©c√©dente
      if(lastWeekKey !== null){
        const sumRow = document.createElement("tr");
        sumRow.innerHTML = `
          <td colspan="9" style="background:#222;text-align:center;
               padding:6px;border:1px solid #444;color:#ddd;">
            ‚û§ Total semaine : <b>${weeklyHours.toFixed(2)} h</b>
            ‚Äî <b>${weeklySalary.toFixed(2)} $</b>
          </td>`;
        tableBody.appendChild(sumRow);
      }

      const sep = document.createElement("tr");
      sep.innerHTML = `
        <td colspan="9" style="background:#00000055;font-weight:bold;
             text-align:center;padding:6px;border:1px solid #333;">
          üìÖ Semaine du <b>${key}</b>
        </td>`;
      tableBody.appendChild(sep);

      weeklyHours = 0;
      weeklySalary = 0;
      lastWeekKey = key;
    }

    tableBody.appendChild(r);

    const h = parseFloat(r.children[4].innerText) || 0;
    const s = parseFloat(r.children[7].innerText) || 0;
    weeklyHours += h;
    weeklySalary += s;
    totalH += h;
    totalS += s;

    // si derni√®re ligne => ajouter total de la semaine en cours
    if(idx === dataRows.length - 1){
      const sumRow = document.createElement("tr");
      sumRow.innerHTML = `
        <td colspan="9" style="background:#222;text-align:center;
             padding:6px;border:1px solid #444;color:#ddd;">
          ‚û§ Total semaine : <b>${weeklyHours.toFixed(2)} h</b>
          ‚Äî <b>${weeklySalary.toFixed(2)} $</b>
        </td>`;
      tableBody.appendChild(sumRow);
    }
  });

  totalHoursEl.textContent  = totalH.toFixed(2);
  totalSalaryEl.textContent = totalS.toFixed(2);

  saveData();
}

// Effacer tout
function clearAll(){
  if (!confirm("Effacer tous les punchs ?")) return;
  tableBody.innerHTML = "";
  recalc();
}

// Sauvegarde auto
function saveData(){
  localStorage.setItem('punch_rows', tableBody.innerHTML);
  localStorage.setItem('punch_rate', rateInput.value);
  localStorage.setItem('theme', document.body.classList.contains('light')?'light':'dark');
}

// Chargement au d√©marrage
function loadData(){
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'light') {
    document.body.classList.add('light');
  }

  const rows = localStorage.getItem('punch_rows');
  if (rows) {
    tableBody.innerHTML = rows;
  }

  const savedRate = localStorage.getItem('punch_rate');
  if (savedRate) {
    rateInput.value = savedRate;
  }

  recalc();
}

// Export CSV
function exportCSV(){
  const header = ["Date","Entr√©e","Sortie","Pause","Heures","Nuit","Weekend","Salaire"];
  const rows = [header];

  tableBody.querySelectorAll('tr').forEach(tr => {
    if(tr.dataset.type === "shift"){
      const cols = Array.from(tr.children).slice(0,8).map(td => td.textContent.replace('$',''));
      rows.push(cols);
    }
  });

  const csv = rows.map(r => r.join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url  = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = "punch.csv";
  a.click();

  URL.revokeObjectURL(url);
}

// Initialisation
document.addEventListener('DOMContentLoaded', () => {
  populateTimeSelect(inSelect);
  populateTimeSelect(outSelect);
  loadData();
});
</script>

</body>
</html>
