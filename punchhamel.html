<!DOCTYPE html>
<html lang="fr">
<head>
<!-- iPhone SE -->
<link rel="apple-touch-startup-image" href="splash/launch-640x1136.png"
 media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)">

<!-- iPhone 6/7/8 -->
<link rel="apple-touch-startup-image" href="splash/launch-750x1334.png"
 media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)">

<!-- iPhone XR / 11 -->
<link rel="apple-touch-startup-image" href="splash/launch-828x1792.png"
 media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)">

<!-- iPhone X / XS / 11 Pro -->
<link rel="apple-touch-startup-image" href="splash/launch-1125x2436.png"
 media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)">

<!-- iPhone 12 / 13 / 14 -->
<link rel="apple-touch-startup-image" href="splash/launch-1170x2532.png"
 media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)">

<!-- iPhone XS Max / 11 Pro Max -->
<link rel="apple-touch-startup-image" href="splash/launch-1242x2688.png"
 media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)">

<!-- iPhone 12/13/14 Pro Max -->
<link rel="apple-touch-startup-image" href="splash/launch-1284x2778.png"
 media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3)">

<!-- iPhone 15 Pro Max -->
<link rel="apple-touch-startup-image" href="splash/launch-1290x2796.png"
 media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3)">

<!-- iPad 9.7" -->
<link rel="apple-touch-startup-image" href="splash/launch-1536x2048.png"
 media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)">

<!-- iPad Pro 10.5" -->
<link rel="apple-touch-startup-image" href="splash/launch-1668x2224.png"
 media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2)">

<!-- iPad Pro 11" -->
<link rel="apple-touch-startup-image" href="splash/launch-1668x2388.png"
 media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)">

<!-- iPad Pro 12.9" -->
<link rel="apple-touch-startup-image" href="splash/launch-2048x2732.png"
 media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)">
<meta charset="UTF-8">
<title>Punch Hamel ‚ùÑ ‚Äî Calcul de salaire</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111">

<style>
:root{
  --bg:#111;
  --card:#1b1b1b;
  --field:#2d2d2d;
  --field-focus:#3a3a3a;
  --text:#ffffff;
}
body.light{
  --bg:#f2f2f2;
  --card:#ffffff;
  --field:#e7e7e7;
  --field-focus:#d4d4d4;
  --text:#111111;
}
body{
  background:var(--bg);
  color:var(--text);
  font-family:Arial, sans-serif;
  margin:0;
  padding:30px;
  transition:background .2s,color .2s;
}
.container{max-width:950px;margin:0 auto;}

.card{
  background:var(--card);
  padding:20px;
  margin-top:10px;
  border-radius:10px;
  border:1px solid #333;
}

input,select{
  padding:8px;
  margin:4px;
  border-radius:6px;
  background:var(--field);
  color:var(--text);
  border:1px solid #555;
  font-weight:500;
}
input:focus,select:focus{
  background:var(--field-focus);
  border-color:#888;
  outline:none;
}

button{
  background:#333;
  color:#fff;
  padding:8px 12px;
  border:none;
  border-radius:6px;
  margin:2px;
  cursor:pointer;
}
button:hover{background:#444;}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
}
th,td{
  border:1px solid #333;
  padding:8px;
  text-align:center;
}

.recap{
  background:var(--card);
  margin-top:15px;
  padding:15px;
  border-radius:10px;
  border:1px solid #222;
}
.info-prime{
  margin:5px 0 0 4px;
  color:gray;
  font-size:13px;
}
</style>

<script>
// toggle th√®me
function toggleTheme(){
  document.body.classList.toggle('light');
  const mode = document.body.classList.contains('light') ? 'light' : 'dark';
  localStorage.setItem('theme', mode);
}

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js');
  });
}
</script>
</head>

<body>

<div class="container">
  <h2>Punch Hamel ‚ùÑ ‚Äî Calcul de salaire</h2>

  <button onclick="toggleTheme()">Mode sombre / clair</button>
  <button onclick="exportCSV()">Exporter CSV</button>

  <div class="card">
    <label>Taux horaire ($/h)</label>
    <input type="number" id="rate" value="35" style="width:80px;"><br><br>

    Date <input type="date" id="date">
    Entr√©e <select id="in"></select>
    Sortie <select id="out"></select>
    Pause (min) <input type="number" id="pause" value="0" style="width:80px;">

    <div class="info-prime">
      Prime nuit : 2$/h (19h ‚Üí 07h) ‚Ä¢ Prime fin semaine : 5$/h (ven 17h ‚Üí lun 05h)
    </div>
    <br>

    <button onclick="addShift()">Ajouter le shift</button>
    <button onclick="clearAll()">Effacer tout</button>

    <table id="table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Entr√©e</th>
          <th>Sortie</th>
          <th>Pause</th>
          <th>Heures</th>
          <th>Nuit h</th>
          <th>Fin sem. h</th>
          <th>Salaire $</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="recap">
      <b>R√©capitulatif</b><br>
      Total heures : <span id="th">0.00</span> h<br>
      Total heures nuit : <span id="tn">0.00</span> h<br>
      Total fin semaine : <span id="twe">0.00</span> h<br>
      <div id="salaryBox">Total salaire brut : <span id="ts">0.00</span> $</div>
      <br>
      <button onclick="toggleSalary()">üëÅÔ∏è Masquer salaire</button>
    </div>
  </div>
</div>

<script>
// ========== R√âF√âRENCES DOM ==========
const inSelect      = document.getElementById('in');
const outSelect     = document.getElementById('out');
const dateInput     = document.getElementById('date');
const pauseInput    = document.getElementById('pause');
const rateInput     = document.getElementById('rate');
const tableBody     = document.querySelector('#table tbody');

const totalH   = document.getElementById('th');
const totalN   = document.getElementById('tn');
const totalW   = document.getElementById('twe');
const totalS   = document.getElementById('ts');
const salaryBox= document.getElementById('salaryBox');

let salaryHidden = false;

// G√©n√®re les heures 00 / 15 / 30 / 45
function populateTimeSelect(sel){
  for(let h=0;h<24;h++){
    for(let m of [0,15,30,45]){
      const HH = String(h).padStart(2,'0');
      const MM = String(m).padStart(2,'0');
      let op = document.createElement("option");
      op.value = `${HH}:${MM}`;
      op.textContent = `${HH}:${MM}`;
      sel.appendChild(op);
    }
  }
}

function overlap(a,b,c,d){
  const start = Math.max(a,c);
  const end = Math.min(b,d);
  return end > start ? (end-start)/36e5 : 0;
}

// Fen√™tre nuit 19h-07h
function nightWindow(startDate){
  const ns = new Date(startDate);
  ns.setHours(19,0,0,0);
  const ne = new Date(startDate);
  ne.setDate(ne.getDate()+1);
  ne.setHours(7,0,0,0);
  return [ns,ne];
}

// Fen√™tre weekend ven 17h ‚Üí lun 05h
function weekendWindow(startDate){
  const d = new Date(startDate);
  const day = d.getDay();
  const fri = new Date(d);
  const offset = (day - 5 + 7) % 7;
  fri.setDate(d.getDate() - offset);
  fri.setHours(17,0,0,0);

  const mon = new Date(fri);
  mon.setDate(fri.getDate()+3);
  mon.setHours(5,0,0,0);

  return [fri,mon];
}
// Construction d'une ligne
function buildRow(d,tin,tout,pauseMin,rate){
  let start = new Date(`${d}T${tin}`);
  let end   = new Date(`${d}T${tout}`);
  if(end <= start) end.setDate(end.getDate()+1);

  const totalHours = (end - start)/36e5 - (pauseMin/60);

  const [wStart,wEnd] = weekendWindow(start);
  const weekendHours = overlap(start.getTime(),end.getTime(),wStart.getTime(),wEnd.getTime());

  const [nStart,nEnd] = nightWindow(start);
  const nightHours = overlap(start.getTime(),end.getTime(),nStart.getTime(),nEnd.getTime());

  const salary = 
      totalHours * rate +
      weekendHours * 5 +
      nightHours * 2;

  let tr = document.createElement("tr");
  tr.dataset.type = "shift";

  tr.innerHTML = `
    <td>${d}</td>
    <td>${tin}</td>
    <td>${tout}</td>
    <td>${pauseMin}</td>
    <td>${totalHours.toFixed(2)}</td>
    <td>${nightHours.toFixed(2)}</td>
    <td>${weekendHours.toFixed(2)}</td>
    <td>${salary.toFixed(2)}</td>
    <td>
      <button onclick="editRow(this)">‚úè</button>
      <button onclick="deleteRow(this)">X</button>
    </td>
  `;
  return tr;
}

// Ajouter shift
function addShift(){
  const d = dateInput.value;
  const tin = inSelect.value;
  const tout = outSelect.value;
  const pauseMin = parseFloat(pauseInput.value)||0;
  const rate = parseFloat(rateInput.value)||0;

  if(!d || !tin || !tout){
    alert("Donn√©es incompl√®tes");
    return;
  }

  const row = buildRow(d,tin,tout,pauseMin,rate);
  tableBody.appendChild(row);
  recalc();
}

// Suppression ligne
function deleteRow(btn){
  btn.closest("tr").remove();
  recalc();
}

// √âdition inline
function editRow(btn){
  const tr = btn.closest("tr");
  const c = tr.children;

  const old = {
    d : c[0].innerText,
    tin: c[1].innerText,
    tout: c[2].innerText,
    pause: c[3].innerText
  };
  tr.dataset.old = JSON.stringify(old);

  // Date
  let dIn = document.createElement("input");
  dIn.type="date";
  dIn.value = old.d;
  c[0].innerHTML="";
  c[0].appendChild(dIn);

  // Entr√©e
  let tIn = document.createElement("select");
  populateTimeSelect(tIn);
  tIn.value = old.tin;
  c[1].innerHTML="";
  c[1].appendChild(tIn);

  // Sortie
  let tOut = document.createElement("select");
  populateTimeSelect(tOut);
  tOut.value = old.tout;
  c[2].innerHTML="";
  c[2].appendChild(tOut);

  // Pause
  let p = document.createElement("input");
  p.type="number";
  p.value = old.pause;
  c[3].innerHTML="";
  c[3].appendChild(p);

  c[8].innerHTML = `
    <button onclick="saveEdit(this)">‚úî</button>
    <button onclick="cancelEdit(this)">‚Ü©</button>
  `;
}

// Sauvegarde modification
function saveEdit(btn){
  const tr = btn.closest("tr");
  const c = tr.children;

  const d    = c[0].querySelector("input").value;
  const tin  = c[1].querySelector("select").value;
  const tout = c[2].querySelector("select").value;
  const pause= parseFloat(c[3].querySelector("input").value)||0;

  const rate = parseFloat(rateInput.value)||0;

  let start = new Date(`${d}T${tin}`);
  let end   = new Date(`${d}T${tout}`);
  if(end <= start) end.setDate(end.getDate()+1);

  const totalHours = (end - start)/36e5 - (pause/60);

  const [wStart,wEnd] = weekendWindow(start);
  const weekendHours = overlap(start.getTime(),end.getTime(),wStart.getTime(),wEnd.getTime());

  const [nStart,nEnd] = nightWindow(start);
  const nightHours = overlap(start.getTime(),end.getTime(),nStart.getTime(),nEnd.getTime());

  const salary =
      totalHours * rate +
      weekendHours * 5 +
      nightHours * 2;

  c[0].innerText = d;
  c[1].innerText = tin;
  c[2].innerText = tout;
  c[3].innerText = pause;
  c[4].innerText = totalHours.toFixed(2);
  c[5].innerText = nightHours.toFixed(2);
  c[6].innerText = weekendHours.toFixed(2);
  c[7].innerText = salary.toFixed(2);

  c[8].innerHTML = `
    <button onclick="editRow(this)">‚úè</button>
    <button onclick="deleteRow(this)">X</button>
  `;
  recalc();
}

// Annuler modification
function cancelEdit(btn){
  const tr = btn.closest("tr");
  const old = JSON.parse(tr.dataset.old);
  const c = tr.children;

  c[0].innerText = old.d;
  c[1].innerText = old.tin;
  c[2].innerText = old.tout;
  c[3].innerText = old.pause;

  c[8].innerHTML = `
    <button onclick="editRow(this)">‚úè</button>
    <button onclick="deleteRow(this)">X</button>
  `;
  recalc();
}

// Masquer / afficher salaire
function toggleSalary(){
  salaryHidden = !salaryHidden;

  document.querySelectorAll("#table td:nth-child(8), #table th:nth-child(8)")
    .forEach(el => el.style.display = salaryHidden ? "none" : "");

  salaryBox.style.display = salaryHidden ? "none" : "";

  document.querySelector("button[onclick='toggleSalary()']").innerText =
    salaryHidden ? "üëÅÔ∏è Afficher salaire" : "üëÅÔ∏è Masquer salaire";

  recalc();
}

// ==== RECALCUL + TRI + GROUPEMENT PAR SEMAINE (DIMANCHE) ====
function recalc(){
  let rows = [...tableBody.querySelectorAll("tr")].filter(r => r.dataset.type==="shift");

  // TRI par date
  rows.sort((a,b)=>
    new Date(a.children[0].innerText) - new Date(b.children[0].innerText)
  );

  tableBody.innerHTML="";

  let lastWeek=null;
  let weekHours=0, weekSalary=0;
  let totH=0, totN=0, totW=0, totS=0;

  rows.forEach((r,i)=>{
    const d = new Date(r.children[0].innerText);

    // DIMANCHE comme d√©but ‚Äî m√©thode simple
    let weekStart = new Date(d);
    weekStart.setDate(d.getDate() - d.getDay());  // üëà CORRECTION DIMANCHE

    let key = weekStart.toISOString().slice(0,10);

    if(key !== lastWeek){
      if(lastWeek !== null){
        addWeekFooter(weekHours, weekSalary);
      }
      addWeekHeader(key);
      weekHours=0;
      weekSalary=0;
      lastWeek = key;
    }

    tableBody.appendChild(r);

    let h  = parseFloat(r.children[4].innerText);
    let hn = parseFloat(r.children[5].innerText);
    let hw = parseFloat(r.children[6].innerText);
    let s  = parseFloat(r.children[7].innerText);

    weekHours += h;
    weekSalary+= s;

    totH += h;
    totN += hn;
    totW += hw;
    totS += s;

    if(i===rows.length-1){
      addWeekFooter(weekHours, weekSalary);
    }
  });

  totalH.textContent = totH.toFixed(2);
  totalN.textContent = totN.toFixed(2);
  totalW.textContent = totW.toFixed(2);
  totalS.textContent = totS.toFixed(2);
}

function addWeekHeader(key){
  let tr = document.createElement("tr");
  tr.innerHTML = `
    <td colspan="9" style="background:#00000055;font-weight:bold;text-align:center;">
      üìÖ Semaine du <b>${key}</b>
    </td>`;
  tableBody.appendChild(tr);
}

function addWeekFooter(h,s){
  let txt = salaryHidden 
    ? `‚û§ Total semaine : <b>${h.toFixed(2)} h</b>`
    : `‚û§ Total semaine : <b>${h.toFixed(2)} h</b> ‚Äî <b>${s.toFixed(2)} $</b>`;

  let tr = document.createElement("tr");
  tr.innerHTML = `
    <td colspan="9" style="background:#222;text-align:center;color:#ddd;">
      ${txt}
    </td>`;
  tableBody.appendChild(tr);
}

// Export CSV
function exportCSV(){
  let rows = [["Date","Entr√©e","Sortie","Pause","Heures","Nuit","Weekend","Salaire"]];

  tableBody.querySelectorAll("tr").forEach(tr=>{
    if(tr.dataset.type==="shift"){
      rows.push([
        tr.children[0].innerText,
        tr.children[1].innerText,
        tr.children[2].innerText,
        tr.children[3].innerText,
        tr.children[4].innerText,
        tr.children[5].innerText,
        tr.children[6].innerText,
        tr.children[7].innerText
      ]);
    }
  });

  let csv = rows.map(r=>r.join(",")).join("\n");
  let blob = new Blob([csv],{type:"text/csv"});
  let url = URL.createObjectURL(blob);

  let a = document.createElement("a");
  a.href = url;
  a.download = "punch.csv";
  a.click();
  URL.revokeObjectURL(url);
}

// Chargement
document.addEventListener("DOMContentLoaded",()=>{
  populateTimeSelect(inSelect);
  populateTimeSelect(outSelect);

  let theme = localStorage.getItem("theme");
  if(theme==="light") document.body.classList.add("light");

  recalc();
});
</script>
</body>
</html>
